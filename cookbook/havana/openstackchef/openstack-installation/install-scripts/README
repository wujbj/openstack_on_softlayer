# Install Scripts

`install_openstack.py` will install OpenStack automatically.

## Usage of insall_openstack.py

A simple usage is: `python install_openstack.py -f nodelist.xml -n cluster_name --all`

Use `--help` option to see full usage.

* -f, --file
  Your nodelist.xml file.

* -r, --ini-file
  ini file name, Default: roles.ini

* -e, --env-tmpl
  Your environment template file, default is `environment.json.tmpl`.

* -n, --cluster-name
  The cluster name specified in nodelist.xml file.

* -E, --create-environment
  If this option is specified, the script will create the environment file

* -S, --show-environment
  If this option is specified, the script will print the final environment file to your screen.

* -U, --upload-environment
  If this option is specified, the script will upload your environment file(You MUST create it first).

* -R, --upload-roles
  If this option is specified, the script will upload your roles.

* -C, --upload-cookbooks
  If this option is specified, the script will upload your cookbooks.

* -D, --dry-run
  If this option is specified, the script will perform a dry run by generating Chef commands.

* -B, --bootstrap
  If this option is specified, the script will bootstrap your nodes.

* -a, --all
  If this option is specified, the script will do all the actions(create environment file,upload environment file,upload roles,upload cookbooks and bootstrap all nodes including controller, compute and cinder nodes).

## Chef Environment Template file

* environment.json.tmpl for OpenStack non-HA installation.

* environment.ha.json.tmpl for OpenStack HA installation.

* environment-sce.json.tmpl for SCE OpenStack installation.

## Node list xml file

* nodelist.xml for multi controller nodes without HA installation.

* nodelist.ha.xml for multi controller nodes with HA installation.

* nodelist.single.xml for single controller node installtion.

## roles.ini file

This file contains the OpenStack Chef roles and its orders.

## Sample Usage

Suppose your xml file is `your_nodelist.xml` and your cluster_name is `your_cluster`:

* Generate Environment file
`python install_openstack.py -f your_nodelist.xml -n your_cluster -E`

* Upload your environment file to Chef server
`python install_openstack.py -f your_nodelist.xml -n your_cluster -U`

* Upload your roles to Chef server
`python install_openstack.py -f your_nodelist.xml -n your_cluster -R`

* Upload your cookbooks to Chef server
`python install_openstack.py -f your_nodelist.xml -n your_cluster -C`

* Perform a dry run
`python install_openstack.py -f your_nodelist.xml -n your_cluster -D`

* Bootstrap your nodes
`python install_openstack.py -f your_nodelist.xml -n your_cluster -B`

* Do all these things above by one command
`python install_openstack.py -f your_nodelist.xml -n your_cluster --all`

OR

`python install_openstack.py -f your_nodelist.xml -n your_cluster -E -U -R -C -B`

### Install OpenStack Environment With HA

You should add `-e` option to the script, like this:

```
# python install_openstack.py -f your_nodelist.xml -n your_cluster -e environment.ha.json.tmpl 
```

### Install OpenStack Environment Without HA

The default environment template file is `environment.json.tmpl`, so you need not to sepcify it.

```
# python install_openstack.py -f your_nodelist.xml -n your_cluster
```

##===================================================

For Developers:

## Sync the clock

Sync the clock of your chef server and other nodes to the time server.

If you have not a time server, you can configure your chef server as your time server.

### Build a NTP time server on chef server

Edit `/etc/ntp.conf` on your chef server, put the two lines to this file.

```
server  127.127.1.0
fudge   127.127.1.0 stratum 10
```

`/etc/init.d/ntpd restart` restart your NTP time server.

When the NTP time server is ok, you can use `ntpdate 172.16.0.4` to adjust the other node's time.(This will usually cost a few minutes)

`chkconfig ntpd on` will let the NTP server automatically start after system reboot.

### Sync the clock of other nodes

Edit `/etc/ntp.conf`, set the NTP server to your chef server, code block.

```
server 9.115.78.197 # chef server IP address
server 1.rhel.pool.ntp.org
server 2.rhel.pool.ntp.org
```

`/etc/init.d/ntpdate start` will adjust the clock, and you need to let it automatically start after system reboot.

### How to add attribute

Take add a `quantum_vip` variable to the environment file as an example.

First, edit `environment.json.tmpl` file:

```
  "override_attributes": {
    "quantum": {
      "quantum-vip": "${QUANTUM_VIP}"       
     }
  }
```

Second, edit `nodelist.xml` file:

As a parent node:
```
<environment attr="value">
    <quantum_vip>1.2.3.4</quantum_vip>
</environment>
```

OR

As a child node:
```
<environment attr="value">
    <xxx>
        <quantum_vip>1.2.3.4</quantum_vip>
    </xxx>
</environment>
```

OR

As an attribute:
```
<environment attr="value">
    <xxx quantum_vip="1.2.3.4" />
</environment>
```

P.S.: The string `${QUANTUM_VIP}` in environment file must be the upper case of `quantum_vip` in `nodelist.xml` file.
